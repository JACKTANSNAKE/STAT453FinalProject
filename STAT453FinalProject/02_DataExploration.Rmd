# Data Exploration

```{r include=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown', 'survival', 'survminer', 'ggplot2', 'caret', 'hrbrthemes', 'viridis'
), 'packages.bib')
```

```{r, echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
library(survival)
library(survminer)
library(tidyverse)
library(caret)
library(hrbrthemes)
library(viridis)
```

## Loading Data
```{r}
data(rotterdam)
```

The data that we are going to use is called `rotterdam`, and it is a dataset that's pre-recorded in the survival package. According to the documentation of the package, the data are retrieved from the Rotterdam tumor bank, which include various anonymous information about patients with breast cancer. Below is a table of the variables in the dataset:

Variable name         |      Description
-----------------     |     -------------------------------------------------------
`pid`                 |      patient identifier
`year`                |      year of cancer incidence
`age`                 |      age
`meno`                |      menopausal status (0= premenopausal, 1= postmenopausal)
`size`                |      tumor size, a factor with levels `<=20`, `20-50`, `>50`
`grade`               |      tumor grade
`nodes`               |      number of positive lymph nodes
`pgr`                 |      progesterone receptors (fmol/l)
`er`                  |      estrogen receptors (fmol/l)
`hormon`              |      hormonal treatment (0=no, 1=yes)
`chemo`               |      chemotherapy
`rtime`               |      days to recurrence or last follow-up
`recur`               |      0= no recurrence, 1= recurrence
`dtime`               |      days to death or last follow-up
`death`               |      0= alive, 1= dead

From the description above, we see that there are `size` which stands for the size of the tumor, `nodes` which stands for how many lymph nodes are test cancer positive, so we have 2 criterions out of the three suggested in the background info.

## Data Wrangling

```{r}
rotterdam %>% 
  group_by(size) %>%
  summarise(number = n(), .groups = 'drop')
```

For lymph nodes, the usual way of classifying the severity would be:`N0` for no positive nodes; `N1` for 1-3 positive nodes; `N2` for  4-9 positive nodes; and `N3` for more than 10 nodes. We will follow this classification and make a new factor called `Nodes_level`

```{r}
rotterdam <- rotterdam %>% 
  mutate(Nodes_level = ifelse(nodes == 0, "N0", 
                              ifelse(nodes >= 1 & nodes <= 3, "N1", 
                                     ifelse(nodes >= 4 & nodes <= 9, "N2", 
                                            ifelse(nodes >= 10, "N3", NaN)))))
rotterdam %>% 
  group_by(Nodes_level) %>%
  summarise(number = n(), .groups = 'drop')
```

Since the `grade` variable in our dataset is a numeric variable whereas we actually want to treat it as a factor, we do the following:

```{r}
rotterdam <- rotterdam %>%
  mutate(grade = as.factor(grade))
```

As we were examining through the data, we found that upon the `chemo` variable and the `hormon` variable, there are instances where patients gets both therapy or neither. So in order to explore the relationship between treatment and survival, we introduce a new variable called `Treatment`, using the `chemo` and `hormon` variables.

```{r}
rotterdam <- rotterdam %>%
  mutate(Treatment = ifelse(chemo == 1 & hormon == 0, "Chemo", ifelse(chemo == 0 & hormon == 1, "Hormon", ifelse(chemo == 1 & hormon == 1, "Both", "NaN/Other Treatment"))))
```

## Data visualizations

### Diagnostics vs. Survival Times

`size` vs. `dtime`
```{r}
ggplot(data = rotterdam, aes(x = size, y = dtime, fill = size)) +
  geom_violin(alpha = 0.7)
```

`size` vs. `rtime`
```{r}
ggplot(data = rotterdam, aes(x = size, y = rtime, fill = size)) +
  geom_violin(alpha = 0.7)
```

`Nodes_level` vs. `dtime`
```{r}
ggplot(data = rotterdam, aes(x = Nodes_level, y = dtime, fill = Nodes_level)) +
  geom_violin(alpha = 0.7)
```

`Nodes_level` vs. `rtime`
```{r}
ggplot(data = rotterdam, aes(x = Nodes_level, y = rtime, fill = Nodes_level)) +
  geom_violin(alpha = 0.7)
```

### Treatment vs. Survival Times

`Treatment` vs. `dtime`
```{r}
ggplot(data = rotterdam, aes(x = Treatment, y = dtime, fill = Treatment)) +
  geom_violin(alpha = 0.7)
```

`Treatment` vs. `rtime`
```{r}
ggplot(data = rotterdam, aes(x = Treatment, y = rtime, fill = Treatment)) +
  geom_violin(alpha = 0.7)
```

A very important criterion in analysis about cancer is the 5-year survival rate. In order to examine that, we introduce a new variable called `5_year_survival`, which indicates 1 if a patients survival time is larger than 5 years and 0 vice versa.

```{r}
rotterdam <- rotterdam %>%
  mutate(dtime_Years = floor(dtime/365)) %>%
  mutate(`5_year_survival` = ifelse(dtime_Years >= 5, 1, 0))
```

Now we want to calculate the 5-year survival rate for the population in the dataset.

```{r}
rotterdam %>% 
  group_by(`5_year_survival`) %>%
  summarise(number = n(), .groups = 'drop')

2084/(898+2084)
```

And also the important 10-year survival rate.

```{r}
rotterdam <- rotterdam %>%
  mutate(dtime_Years = floor(dtime/365)) %>%
  mutate(`10_year_survival` = ifelse(dtime_Years >= 10, 1, 0))
```

Now we calculate the 10-year survival rate for the population in the dataset.

```{r}
rotterdam %>% 
  group_by(`10_year_survival`) %>%
  summarise(number = n(), .groups = 'drop')

685/(685 + 2297)
```
