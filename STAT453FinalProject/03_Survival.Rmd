# Survival

```{r, echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
library(survival)
library(survminer)
library(tidyverse)
library(caret)
library(hrbrthemes)
library(viridis)
```

## Loading Data
```{r}
data(rotterdam)
```

```{r, echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
rotterdam <- rotterdam %>%
  mutate(Treatment = ifelse(chemo == 1 & hormon == 0, "Chemo", ifelse(chemo == 0 & hormon == 1, "Hormon", ifelse(chemo == 1 & hormon == 1, "Both", "NaN/Other Treatment"))))
rotterdam <- rotterdam %>% 
  mutate(Nodes_level = ifelse(nodes == 0, "N0", 
                              ifelse(nodes >= 1 & nodes <= 3, "N1", 
                                     ifelse(nodes >= 4 & nodes <= 9, "N2", 
                                            ifelse(nodes >= 10, "N3", NaN)))))
rotterdam <- rotterdam %>%
  mutate(grade = as.factor(grade))
```

## Kaplan-Miere

### `size` vs. Survival Times

`size` vs. `dtime`
```{r}
KM_None_Death <- survfit(Surv(dtime, death) ~ size, data = rotterdam)
plot(KM_None_Death, conf.type = "plain", col = c("blue","red","purple"), xlab="Days", ylab="Survival", lty = 1:3)
```

`size` vs. `rtime`
```{r}
KM_None_Recur <- survfit(Surv(rtime, recur) ~ size, data = rotterdam)
plot(KM_None_Recur, conf.type = "plain", col = c("blue","red","purple"), xlab="Days", ylab="Survival", lty = 1:3)
```

### `Nodes_level` vs. Survival Times

`size` vs. `dtime`
```{r}
KM_None_Death <- survfit(Surv(dtime, death) ~ Nodes_level, data = rotterdam)
plot(KM_None_Death, conf.type = "plain", col = c("blue","red","purple","green"), xlab="Days", ylab="Survival", lty = 1:4)
```

`size` vs. `rtime`
```{r}
KM_None_Recur <- survfit(Surv(rtime, recur) ~ Nodes_level, data = rotterdam)
plot(KM_None_Recur, conf.type = "plain", col = c("blue","red","purple", "green"), xlab="Days", ylab="Survival", lty = 1:4)
```

### `Treatment` vs. Survival Times

`Treatment` vs. `dtime`
```{r warning=FALSE}
KM_Treatment_Death <- survfit(Surv(dtime, death) ~ Treatment, data = rotterdam)
plot(KM_Treatment_Death, conf.int = FALSE, col = c("blue", "red", "purple", "green"), xlab="Days", ylab="Survival", lty=1:4)
legend(1, 0.4, legend=c("Both", "Chemo","Hormon", "NaN/Other Treatment"),
       col=c("blue", "red", "purple", "green"), lty=1:4, cex=0.8,
       title="Treatment Group", text.font=6)
```

`Treatment` vs. `rtime`
```{r}
KM_Treatment_Recur <- survfit(Surv(rtime, recur) ~ Treatment, data = rotterdam)
plot(KM_Treatment_Recur, conf.int = FALSE, col = c("blue", "red", "purple", "green"), xlab="Days", ylab="Survival", lty=1:4)
legend(1, 0.4, legend=c("Both", "Chemo","Hormon", "NaN/Other Treatment"),
       col=c("blue", "red", "purple", "green"), lty=1:4, cex=0.8,
       title="Treatment Group", text.font=6)
```

## Parametric Models 

```{r}
### Introduce the CoxSnell residuals for parametric model assessment
CoxSnell = function(cs,status,xlim=NULL,ylim=NULL)
{
kmcs = survfit( Surv(jitter(cs,amount=(max(cs)-min(cs))/1000),status) ~ 1 )$surv

plot( log(-log(kmcs)) ~ sort(log(cs)) ,
      xlab="log(Cox-Snell)", ylab="log(-log(S(Cox-Snell)))", xlim=xlim, ylim=ylim )

abline(0,1,col='red')
}
```

### Diagnostics vs. Survival Times

Exponential model:
```{r}
DexpFactoredNodes <- survreg(Surv(dtime, death) ~ size + Nodes_level, dist='exponential', data=rotterdam)
DexpNumericNodes <- survreg(Surv(dtime, death) ~ size + nodes, dist='exponential', data=rotterdam)
DexpFactoredNodes
DexpNumericNodes
```

```{r}
CSFactored = -log(1 - pexp(rotterdam$dtime, 1/exp(9.4580834-0.4079558*ifelse(rotterdam$size=="20-50",1,0)-0.7156137*ifelse(rotterdam$size==">50",1,0)-0.5001880*ifelse(rotterdam$Nodes_level=="N1",1,0)-0.9946036*ifelse(rotterdam$Nodes_level=="N2",1,0)-1.3062361*ifelse(rotterdam$Nodes_level=="N3",1,0))))
# Make appropriate graph using CoxSnell function
CoxSnell(CSFactored, rotterdam$death)

CSNumeric = -log(1 - pexp(rotterdam$dtime, 1/exp(9.25807238-0.48559190*ifelse(rotterdam$size=="20-50",1,0)-0.87914002*ifelse(rotterdam$size==">50",1,0)-0.07094178*rotterdam$nodes)))
# Make appropriate graph using CoxSnell function
CoxSnell(CSNumeric, rotterdam$death)
```

Weibull model:
```{r}
DweibullFactoredNodes <- survreg(Surv(dtime, death) ~ size + Nodes_level, dist='weibull', data=rotterdam)
DweibullNumericNodes <- survreg(Surv(dtime, death) ~ size + nodes, dist='weibull', data=rotterdam)
DweibullFactoredNodes
DweibullNumericNodes
```

```{r}
CSFactored = -log(1 - pweibull(rotterdam$dtime, 1/0.7423267, exp(9.1139316-0.3138368*ifelse(rotterdam$size=="20-50",1,0)-0.5771036*ifelse(rotterdam$size==">50",1,0)-0.3840287*ifelse(rotterdam$Nodes_level=="N1",1,0)-0.7862627*ifelse(rotterdam$Nodes_level=="N2",1,0)-1.0530855*ifelse(rotterdam$Nodes_level=="N3",1,0))))
# Make appropriate graph using CoxSnell function
CoxSnell(CSFactored, rotterdam$death)

CSNumeric = -log(1 - pweibull(rotterdam$dtime, 1/0.748139, exp(8.96551068-0.37327053*ifelse(rotterdam$size=="20-50",1,0)-0.71478411*ifelse(rotterdam$size==">50",1,0)-0.05733795*rotterdam$nodes)))
# Make appropriate graph using CoxSnell function
CoxSnell(CSNumeric, rotterdam$death)
```

Log-normal model:
```{r}
DlnormFactoredNodes <- survreg(Surv(dtime, death) ~ size + Nodes_level, dist='lognormal', data=rotterdam)
DlnormNumericNodes <- survreg(Surv(dtime, death) ~ size + nodes, dist='lognormal', data=rotterdam)
DlnormFactoredNodes
DlnormNumericNodes
```

```{r}
CSFactored = -log(1 - plnorm(rotterdam$dtime,   8.8734197-0.3292566*ifelse(rotterdam$size=="20-50",1,0)-0.6043081*ifelse(rotterdam$size==">50",1,0) -0.4020603*ifelse(rotterdam$Nodes_level=="N1",1,0)-0.8575354*ifelse(rotterdam$Nodes_level=="N2",1,0)-1.1966395*ifelse(rotterdam$Nodes_level=="N3",1,0), 1.070683))
# Make appropriate graph using CoxSnell function
CoxSnell(CSFactored, rotterdam$death)

CSNumeric = -log(1 - plnorm(rotterdam$dtime, 8.75960765 - 0.38390034*ifelse(rotterdam$size=="20-50",1,0)-0.70016258*ifelse(rotterdam$size==">50",1,0) -0.07917648*rotterdam$nodes, 1.08368))

CoxSnell(CSNumeric, rotterdam$death)
```

### Diagnostics vs. Recurrence Times

Exponential model:
```{r}
DexpFactoredNodes <- survreg(Surv(rtime, recur) ~ size + Nodes_level, dist='exponential', data=rotterdam)
DexpNumericNodes <- survreg(Surv(rtime, recur) ~ size + nodes, dist='exponential', data=rotterdam)
DexpFactoredNodes
DexpNumericNodes
```

```{r}
CSFactored = -log(1 - pexp(rotterdam$rtime, 1/exp(8.9222448-0.3234604*ifelse(rotterdam$size=="20-50",1,0)-0.5439809*ifelse(rotterdam$size==">50",1,0)-0.3714043*ifelse(rotterdam$Nodes_level=="N1",1,0)-0.9934901*ifelse(rotterdam$Nodes_level=="N2",1,0)-1.4131380*ifelse(rotterdam$Nodes_level=="N3",1,0))))
# Make appropriate graph using CoxSnell function
CoxSnell(CSFactored, rotterdam$recur)

CSNumeric = -log(1 - pexp(rotterdam$rtime, 1/exp(8.78007732 -0.39027711*ifelse(rotterdam$size=="20-50",1,0)-0.68814113*ifelse(rotterdam$size==">50",1,0)-0.08100318*rotterdam$nodes)))
# Make appropriate graph using CoxSnell function
CoxSnell(CSNumeric, rotterdam$recur)
```

Weibull model:
```{r}
DweibullFactoredNodes <- survreg(Surv(rtime, recur) ~ size + Nodes_level, dist='weibull', data=rotterdam)
DweibullNumericNodes <- survreg(Surv(rtime, recur) ~ size + nodes, dist='weibull', data=rotterdam)
DweibullFactoredNodes
DweibullNumericNodes
```

```{r}
CSFactored = -log(1 - pweibull(rotterdam$rtime, 1/1.008247, exp(8.9297745-0.3256748*ifelse(rotterdam$size=="20-50",1,0)-0.5464318*ifelse(rotterdam$size==">50",1,0)-0.3737779*ifelse(rotterdam$Nodes_level=="N1",1,0)-0.9991092*ifelse(rotterdam$Nodes_level=="N2",1,0)-1.4204576*ifelse(rotterdam$Nodes_level=="N3",1,0))))
# Make appropriate graph using CoxSnell function
CoxSnell(CSFactored, rotterdam$recur)

CSNumeric = -log(1 - pweibull(rotterdam$rtime, 1/1.018449, exp(8.79497805-0.39619564*ifelse(rotterdam$size=="20-50",1,0)-0.69507535*ifelse(rotterdam$size==">50",1,0)-0.08199745*rotterdam$nodes)))
# Make appropriate graph using CoxSnell function
CoxSnell(CSNumeric, rotterdam$recur)
```

Log-normal model:
```{r}
DlnormFactoredNodes <- survreg(Surv(rtime, recur) ~ size + Nodes_level, dist='lognormal', data=rotterdam)
DlnormNumericNodes <- survreg(Surv(rtime, recur) ~ size + nodes, dist='lognormal', data=rotterdam)
DlnormFactoredNodes
DlnormNumericNodes
```

```{r}
CSFactored = -log(1 - plnorm(rotterdam$rtime,   8.5287301-0.3990732*ifelse(rotterdam$size=="20-50",1,0)-0.6058651*ifelse(rotterdam$size==">50",1,0) -0.3437357*ifelse(rotterdam$Nodes_level=="N1",1,0)-0.9944863*ifelse(rotterdam$Nodes_level=="N2",1,0)-1.4794706*ifelse(rotterdam$Nodes_level=="N3",1,0), 1.335044))
# Make appropriate graph using CoxSnell function
CoxSnell(CSFactored, rotterdam$recur)

CSNumeric = -log(1 - plnorm(rotterdam$rtime, 8.4375379 - 0.4427015*ifelse(rotterdam$size=="20-50",1,0)-0.6916485*ifelse(rotterdam$size==">50",1,0) -0.1014937*rotterdam$nodes, 1.08368))

CoxSnell(CSNumeric, rotterdam$recur)
```

### Treatment vs. Survival Times

Exponential model:
```{r}
Dexp <- survreg(Surv(dtime, death) ~ Treatment, dist='exponential', data=rotterdam)
Dexp
```

```{r}
CS = -log(1 - pexp(rotterdam$dtime, 1/exp(9.2675474-0.6178274*ifelse(rotterdam$Treatment=="TreatmentChemo",1,0)-0.9740923*ifelse(rotterdam$Treatment=="TreatmentHormon",1,0)-0.4801527*ifelse(rotterdam$Treatment=="TreatmentNaN/Other Treatment",1,0))))
# Make appropriate graph using CoxSnell function
CoxSnell(CS, rotterdam$death)
```

Weibull model:
```{r}
Dweibull <- survreg(Surv(dtime, death) ~ Treatment, dist='weibull', data=rotterdam)
Dweibull
```

```{r}
CS = -log(1 - pweibull(rotterdam$dtime, 1/0.7853686, exp(9.0256920-0.5087149*ifelse(rotterdam$Treatment=="TreatmentChemo",1,0)-0.8529757*ifelse(rotterdam$Treatment=="TreatmentHormon",1,0)-0.3952678*ifelse(rotterdam$Treatment=="TreatmentNaN/Other Treatment",1,0))))
# Make appropriate graph using CoxSnell function
CoxSnell(CS, rotterdam$death)
```

Log-normal model:
```{r}
Dlnorm <- survreg(Surv(dtime, death) ~ Treatment, dist='lognormal', data=rotterdam)
Dlnorm
```

```{r}
CS = -log(1 - plnorm(rotterdam$dtime,   8.7552607-0.4988799*ifelse(rotterdam$Treatment=="TreatmentChemo",1,0)-0.8119019*ifelse(rotterdam$Treatment=="TreatmentHormon",1,0) -0.3782626*ifelse(rotterdam$Treatment=="TreatmentNaN/Other Treatment",1,0), 1.193984))
# Make appropriate graph using CoxSnell function
CoxSnell(CS, rotterdam$death)
```

### Treatment vs. Survival Times

Exponential model:
```{r}
Dexp <- survreg(Surv(rtime, recur) ~ Treatment, dist='exponential', data=rotterdam)
Dexp
```

```{r}
CS = -log(1 - pexp(rotterdam$rtime, 1/exp(8.6387571-0.4806280*ifelse(rotterdam$Treatment=="TreatmentChemo",1,0)-0.6736760*ifelse(rotterdam$Treatment=="TreatmentHormon",1,0)-0.2245649*ifelse(rotterdam$Treatment=="TreatmentNaN/Other Treatment",1,0))))
# Make appropriate graph using CoxSnell function
CoxSnell(CS, rotterdam$recur)
```

Weibull model:
```{r}
Dweibull <- survreg(Surv(rtime, recur) ~ Treatment, dist='weibull', data=rotterdam)
Dweibull
```

```{r}
CS = -log(1 - pweibull(rotterdam$dtime, 1/1.081885, exp(8.6886491-0.5055531*ifelse(rotterdam$Treatment=="TreatmentChemo",1,0)-0.6910078*ifelse(rotterdam$Treatment=="TreatmentHormon",1,0)-0.2332029*ifelse(rotterdam$Treatment=="TreatmentNaN/Other Treatment",1,0))))
# Make appropriate graph using CoxSnell function
CoxSnell(CS, rotterdam$recur)
```

Log-normal model:
```{r}
Dlnorm <- survreg(Surv(rtime, recur) ~ Treatment, dist='lognormal', data=rotterdam)
Dlnorm
```

```{r}
CS = -log(1 - plnorm(rotterdam$rtime,   8.3190087-0.5373331*ifelse(rotterdam$Treatment=="TreatmentChemo",1,0)-0.6984793*ifelse(rotterdam$Treatment=="TreatmentHormon",1,0) -0.3175542*ifelse(rotterdam$Treatment=="TreatmentNaN/Other Treatment",1,0), 1.490703))
# Make appropriate graph using CoxSnell function
CoxSnell(CS, rotterdam$recur)
```

## Cox-PH


